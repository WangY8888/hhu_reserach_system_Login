<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ²³æµ·å¤§å­¦æ™ºæ…§ç ”ç©¶ç”Ÿç§‘ç ”ç³»ç»Ÿ</title>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <style>
    /* ------------------ ä½ çš„åŸæœ‰æ ·å¼ï¼ˆä¿ç•™ï¼‰ ------------------ */
    * { margin:0; padding:0; box-sizing:border-box; font-family:"Microsoft YaHei",sans-serif; cursor: default; }
    body {
      overflow:auto; min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
      color:#e0f7ff;
      background-image: url("æ²³æµ·æ ¡å¾½.png");
      background-repeat:no-repeat; background-position:center center; background-size:cover; background-color:transparent;
      padding-top: 64px;
    }
    header {
      position: fixed; top: 0; width: 100%; height: 54px; background: rgba(255,255,255,0.6); box-shadow: 0 1px 5px rgba(0,0,0,0.15);
      display:flex; align-items:center; padding: 0 16px; z-index: 50;
    }
    header h1 { margin-left: 8px; color:#0348b0; font-size:18px; }
    nav { margin-left:auto; display:flex; gap:12px; align-items:center; }
    nav a { text-decoration:none; color:#033d94; font-weight:600; font-size:13px; }
    main { width: 90%; max-width: 960px; margin-top: 18px; display:grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap:16px; }

    .card { background:#0348b0; color:#fff; padding:14px; border-radius:12px; box-shadow:0 6px 16px rgba(3,72,176,0.18); cursor:pointer; }
    .card h3 { margin-bottom:6px; font-size:14px; }

    .newcard, .newcard2, .newcard4 {
      position: relative; display:none; width:100%; max-width:640px; background:#fff; color:#033d94; border-radius:14px; padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,0.12); margin: 18px auto;
    }
    .newcard h2, .newcard2 h2, .newcard4 h2 { color:#0348b0; margin-bottom:12px; }
    .newcard label { display:block; margin:8px 0 4px; font-weight:700; }
    .newcard input, .newcard textarea { width:100%; padding:8px; border:1px solid #cfe2ff; border-radius:6px; }
    .newcard button { margin-top:10px; padding:8px 12px; background:#0348b0; color:#fff; border:none; border-radius:6px; cursor:pointer; }

    /* calendar + log area */
    .calendar-log-container { width:90%; max-width:960px; display:flex; gap:18px; align-items:flex-start; margin: 12px auto 36px; }
    #calendar-container { width:220px; background:#f0f8ff; border-radius:8px; padding:10px; border:2px solid #0348b0; }
    #log-container { flex:1; min-height:220px; background:#f0f8ff; border-radius:8px; padding:10px; border:2px solid #0348b0; }

    .log-content { max-height:300px; overflow:auto; }
    .log-entry { margin-bottom:12px; padding-bottom:8px; border-bottom:1px dashed #acc3e3; }

    /* small timeline lists for experiments & progress */
    .history-list { margin-top:12px; max-height:260px; overflow:auto; background:#fff; border-radius:8px; padding:8px; border:1px solid #e6eefc; }
    .history-item { padding:8px; border-bottom:1px solid #f1f6ff; }
    .history-item strong { color:#0348b0; }

    /* message/toast */
    #message { position: fixed; right: 20px; top: 80px; z-index:9999; display:none; padding:12px 16px; border-radius:8px; color:white; font-weight:700; box-shadow:0 6px 18px rgba(0,0,0,0.18); }
    #message.success { background:#4caf50; }
    #message.error { background:#f44336; }
    #message.info { background:#2196f3; }
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center">
      <img src="æ²³æµ·å¤§å­¦æ ¡å¾½.png" alt="logo" width="34" height="34">
      <h1>æ²³æµ·å¤§å­¦æ™ºæ…§ç ”ç©¶ç”Ÿç§‘ç ”ç³»ç»Ÿ</h1>
    </div>
    <nav id="app">
      <a href="#">ä¸»é¡µ</a>
      <a href="#"><i class="fas fa-user"></i> <u>{{ username }}</u></a>
      <a id="logoutBtn" href="#"><i class="fas fa-sign-out-alt"></i> ç™»å‡º</a>
    </nav>
  </header>

  <div id="message"></div>

  <main>
    <div class="card" id="card-add-exp"><h3>ğŸ“Œ æ·»åŠ å®éªŒè®°å½•</h3><p>ä¿å­˜å®éªŒæ•°æ®å¹¶æŸ¥çœ‹å†å²ã€‚</p></div>
    <div class="card" id="card-add-progress"><h3>ğŸ“„ å¡«å†™è®ºæ–‡è¿›åº¦</h3><p>è®°å½•è®ºæ–‡å½“å‰è¿›å±•ã€‚</p></div>
    <div class="card" id="card-manage-lit"><h3>ğŸ“š ç®¡ç†æ–‡çŒ®åº“</h3><p>æ·»åŠ ä¸æŸ¥çœ‹æ–‡çŒ®ã€‚</p></div>
  </main>

  <div class="calendar-log-container">
    <div id="calendar-container">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <button id="prev-month">&lt;</button>
        <div id="month-year"></div>
        <button id="next-month">&gt;</button>
      </div>
      <table id="calendar-table" style="width:100%;border-collapse:collapse;">
        <thead><tr><th>æ—¥</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th></tr></thead>
        <tbody id="calendar-body"></tbody>
      </table>
    </div>

    <div id="log-container">
      <h3>ä¸ªäººæ—¥å¿—</h3>
      <div class="log-content" id="logsList">
        <div class="log-entry"><h4>æš‚æ— æ—¥å¿—</h4><p>å°šæœªåˆ›å»ºä»»ä½•æ—¥å¿—</p></div>
      </div>
      <div style="margin-top:8px;">
        <textarea id="log-input" placeholder="å†™ä¸‹æ‚¨çš„æ—¥å¿—..." rows="3" style="width:100%;"></textarea>
        <button id="save-log" style="float:right;margin-top:8px;">ä¿å­˜æ—¥å¿—</button>
      </div>
    </div>
  </div>

  <!-- å¼¹çª—åŒºï¼ˆä»¥å¡ç‰‡å½¢å¼æ˜¾ç¤ºåœ¨é¡µé¢ä¸­ï¼‰ -->
  <div class="newcard" id="newcard1">
    <h2>æ·»åŠ å®éªŒè®°å½•</h2>
    <form id="addExperimentForm">
      <label>å®éªŒåç§°ï¼š</label>
      <input id="expName" name="expName" required>
      <label>å®éªŒæ—¥æœŸï¼š</label>
      <input id="expDate" name="expDate" type="date" required>
      <label>å®éªŒæ•°æ®ï¼š</label>
      <textarea id="expData" name="expData" rows="3"></textarea>
      <label>å®éªŒå¤‡æ³¨ï¼š</label>
      <textarea id="expNote" name="expNote" rows="2"></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button type="submit">ä¿å­˜å®éªŒè®°å½•</button>
        <button type="button" id="backBtn">è¿”å›ä¸»é¡µ</button>
      </div>

      <div class="history-list" id="experimentHistoryContainer">
        <strong>å†å²å®éªŒè®°å½•ï¼ˆæœ€è¿‘ï¼‰</strong>
        <div id="experiment-list"></div>
      </div>
    </form>
  </div>

  <div class="newcard2" id="newcard2">
    <h2>å¡«å†™è®ºæ–‡è¿›åº¦</h2>
    <form id="progressForm">
      <label>è¿›åº¦æ¦‚è¿°ï¼š</label>
      <input id="progressSummary" required>
      <label>å…·ä½“å®Œæˆé¡¹ï¼š</label>
      <input id="completedTasks" required>
      <label>ç»“æœäº§å‡ºï¼š</label>
      <textarea id="output" rows="2"></textarea>
      <label>é‡åˆ°çš„é—®é¢˜ï¼š</label>
      <textarea id="issues" rows="2"></textarea>
      <label>ä¸‹é˜¶æ®µè®¡åˆ’ï¼š</label>
      <textarea id="nextPlan" rows="2"></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button type="submit">ä¿å­˜è¿›åº¦</button>
        <button type="button" id="backBtn2">è¿”å›ä¸»é¡µ</button>
      </div>

      <div class="history-list" id="progressHistoryContainer">
        <strong>å†å²è¿›åº¦ï¼ˆæœ€è¿‘ï¼‰</strong>
        <div id="progress-list"></div>
      </div>
    </form>
  </div>

  <div class="newcard4" id="newcard4">
    <h2>ç®¡ç†æ–‡çŒ®åº“</h2>
    <form id="literatureForm">
      <label>æ–‡çŒ®æ ‡é¢˜ï¼š</label><input id="title" required>
      <label>ä½œè€…ï¼š</label><input id="authors" required>
      <label>æœŸåˆŠ/ä¼šè®®ï¼š</label><input id="journal">
      <label>å¹´ä»½ï¼š</label><input id="year" type="number" min="1900" max="2100">
      <label>å…³é”®è¯ï¼š</label><input id="keywords">
      <label>æ‘˜è¦ï¼š</label><textarea id="abstract" rows="3"></textarea>
      <label>é“¾æ¥ï¼š</label><input id="link" type="url">
      <label>å¤‡æ³¨ï¼š</label><textarea id="notes" rows="2"></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button type="submit">ä¿å­˜æ–‡çŒ®</button>
        <button type="button" id="backBtn4">è¿”å›ä¸»é¡µ</button>
      </div>

      <div class="history-list" id="literatureHistoryContainer">
        <strong>å†å²æ–‡çŒ®ï¼ˆæœ€è¿‘ï¼‰</strong>
        <div id="literature-list"></div>
      </div>
    </form>
  </div>

<script>
  // Vue for header username
  new Vue({ el: "#app", data: { username: sessionStorage.getItem('username') || 'æœªç™»å½•' } });

  const BASE_URL = "https://hhu-reserach-system.onrender.com"; // <- å¦‚æœä½ çš„åç«¯åŸŸåä¸åŒè¯·ä¿®æ”¹

  // -------------------- é€šç”¨ UI & å·¥å…·å‡½æ•° --------------------
  function showMessage(message, type = 'success') {
    const el = document.getElementById('message');
    el.textContent = message;
    el.className = '';
    el.classList.add(type === 'error' ? 'error' : type === 'info' ? 'info' : 'success');
    el.style.display = 'block';
    // è‡ªåŠ¨éšè—
    clearTimeout(el._hideTimer);
    el._hideTimer = setTimeout(() => { el.style.display = 'none'; }, 3000);
  }

  function escapeHtml(str) {
    if (!str && str !== 0) return '';
    return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;').replaceAll('\n','<br>');
  }

  function formatDateTime(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const hh = String(d.getHours()).padStart(2,'0');
    const min = String(d.getMinutes()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd} ${hh}:${min}`;
  }

  // é€šç”¨æ¸²æŸ“ï¼šå°† record æ’å…¥åˆ°é¡µé¢å¯¹åº”çš„åˆ—è¡¨ï¼ˆexperiment / progress / log / literatureï¼‰
  // record æ˜¯å¯¹è±¡ï¼Œtype æ˜¯ 'experiment'|'paper'|'log'|'literature'
  function prependRecordToUI(type, record, options = { temp: false }) {
    let container;
    if (type === 'experiment') container = document.getElementById('experiment-list');
    else if (type === 'paper') container = document.getElementById('progress-list');
    else if (type === 'log') container = document.getElementById('logsList');
    else if (type === 'literature') container = document.getElementById('literature-list');
    if (!container) return;

    // å¦‚æœå·²ç»å­˜åœ¨åŒ id çš„ä¸´æ—¶æ¡ç›®ï¼Œå…ˆç§»é™¤ï¼ˆé¿å…é‡å¤ï¼‰
    if (record && record.id) {
      const existing = container.querySelector(`[data-id="${record.id}"]`);
      if (existing) existing.remove();
    }

    const entry = document.createElement('div');
    entry.className = type === 'log' ? 'log-entry' : 'history-item';
    if (record && record.id) entry.setAttribute('data-id', record.id);
    if (options.temp) entry.setAttribute('data-temp', '1');

    // ä¸åŒç±»å‹æ˜¾ç¤ºå†…å®¹ç•¥æœ‰ä¸åŒ
    if (type === 'experiment') {
      entry.innerHTML = `<div><strong>${escapeHtml(record.expName || '(æ— åç§°)')}</strong>
        <div style="font-size:12px;color:#666">${formatDateTime(record.created_at || record.expDate || (new Date()).toISOString())}</div>
        <div style="margin-top:6px;"><strong>æ•°æ®ï¼š</strong>${escapeHtml(record.expData || '-')}</div>
        <div><strong>å¤‡æ³¨ï¼š</strong>${escapeHtml(record.expNote || '-')}</div>
        <div style="margin-top:6px;font-size:12px;color:#999"><em>${options.temp ? 'ï¼ˆå·² æœ¬åœ° æ˜¾ç¤ºï¼Œç¨åä¼šåŒæ­¥çœŸå®æ•°æ®ï¼‰' : ''}</em></div>
      </div>`;
    } else if (type === 'paper') {
      entry.innerHTML = `<div><strong>${escapeHtml(record.progress_summary || '(æ— æ¦‚è¿°)')}</strong>
        <div style="font-size:12px;color:#666">${formatDateTime(record.created_at || (new Date()).toISOString())}</div>
        <div style="margin-top:6px;"><strong>å®Œæˆé¡¹ï¼š</strong>${escapeHtml(record.completed_items || '-')}</div>
        <div><strong>ç»“æœï¼š</strong>${escapeHtml(record.result_output || '-')}</div>
        <div><strong>é—®é¢˜ï¼š</strong>${escapeHtml(record.problems_encountered || '-')}</div>
        <div><strong>ä¸‹é˜¶æ®µï¼š</strong>${escapeHtml(record.next_plan || '-')}</div>
        <div style="margin-top:6px;font-size:12px;color:#999"><em>${options.temp ? 'ï¼ˆå·² æœ¬åœ° æ˜¾ç¤ºï¼Œç¨åä¼šåŒæ­¥çœŸå®æ•°æ®ï¼‰' : ''}</em></div>
      </div>`;
    } else if (type === 'log') {
      entry.innerHTML = `<h4>${escapeHtml(record.title || 'ä¸ªäººæ—¥å¿—')} <small style="font-weight:600;color:#666;margin-left:8px;font-size:12px">${formatDateTime(record.created_at || record.log_date)}</small></h4>
        <p>${escapeHtml(record.content)}</p>`;
    } else if (type === 'literature') {
      entry.innerHTML = `<div><strong>${escapeHtml(record.title || '(æ— æ ‡é¢˜)')}</strong>
        <div style="font-size:12px;color:#666">${formatDateTime(record.created_at || (new Date()).toISOString())}</div>
        <div style="margin-top:6px;"><strong>ä½œè€…ï¼š</strong>${escapeHtml(record.authors || '-')}</div>
        <div><strong>æœŸåˆŠï¼š</strong>${escapeHtml(record.journal || '-')}</div></div>`;
    }

    container.insertBefore(entry, container.firstChild);
  }

  // -------------------- æ§åˆ¶å¼¹çª—æ˜¾ç¤º/éšè— --------------------
  function showNewcard(id) {
    document.querySelectorAll('.newcard, .newcard2, .newcard4').forEach(el=> el.style.display='none');
    const el = document.getElementById(id);
    if (el) el.style.display = 'block';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  function hideAllNewcards() {
    document.querySelectorAll('.newcard, .newcard2, .newcard4').forEach(el=> el.style.display='none');
  }

  // é¡¶éƒ¨å¡ç‰‡ç»‘å®š
  document.getElementById('card-add-exp').addEventListener('click', ()=> { showNewcard('newcard1'); setTimeout(loadExperimentList,120); });
  document.getElementById('card-add-progress').addEventListener('click', ()=> { showNewcard('newcard2'); setTimeout(loadProgressList,120); });
  document.getElementById('card-manage-lit').addEventListener('click', ()=> { showNewcard('newcard4'); setTimeout(loadLiteratureList,120); });

  document.getElementById('backBtn').addEventListener('click', ()=> hideAllNewcards());
  document.getElementById('backBtn2').addEventListener('click', ()=> hideAllNewcards());
  document.getElementById('backBtn4').addEventListener('click', ()=> hideAllNewcards());

  // ç™»å‡ºè·³è½¬
  document.getElementById('logoutBtn').addEventListener('click', function(e){
    e.preventDefault();
    sessionStorage.removeItem('username');
    window.location.href = 'https://login-mbxl.onrender.com'; // æŒ‰ä½ è¦æ±‚çš„è·³è½¬
  });

  // -------------------- å®éªŒï¼šä¿å­˜ & æ‹‰å– --------------------
  async function saveExperiment(evt) {
    if (evt && evt.preventDefault) evt.preventDefault();
    const expName = document.getElementById('expName').value.trim();
    const expDate = document.getElementById('expDate').value;
    const expData = document.getElementById('expData').value.trim();
    const expNote = document.getElementById('expNote').value.trim();
    const username = sessionStorage.getItem('username') || localStorage.getItem('username');
    if (!username) { showMessage('æœªæ£€æµ‹åˆ°ç™»å½•ç”¨æˆ·ï¼Œè¯·å…ˆç™»å½•','error'); return; }
    if (!expName) { showMessage('è¯·å¡«å†™å®éªŒåç§°','error'); return; }

    try {
      const payload = { username, expName, expDate, expData, expNote };
      const res = await fetch(`${BASE_URL}/addExperiment`, {
        method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data && data.success) {
        showMessage('å®éªŒè®°å½•ä¿å­˜æˆåŠŸ','success');

        // ç”¨ä¸´æ—¶å¯¹è±¡æ¸²æŸ“ï¼Œéšååˆ·æ–°åˆ—è¡¨ä»¥è·å–åç«¯çœŸå®æ•°æ®ï¼ˆé¿å…é‡å¤ï¼‰
        const tempRecord = { id: 'temp-' + Date.now(), expName, expDate, expData, expNote, created_at: new Date().toISOString() };
        prependRecordToUI('experiment', tempRecord, { temp: true });

        // æ¸…ç©ºè¡¨å•
        document.getElementById('addExperimentForm').reset();

        // å¼‚æ­¥åˆ·æ–°çœŸå®åˆ—è¡¨ï¼ˆä¼šæŠŠçœŸå®æ•°æ®æ’å…¥ï¼‰
        await loadExperimentList();
      } else {
        showMessage('ä¿å­˜å¤±è´¥ï¼š' + (data && (data.error || data.reason) ? (data.error || data.reason) : 'æœªçŸ¥é”™è¯¯'),'error');
        console.error('addExperiment response', data);
      }
    } catch (err) {
      console.error(err);
      showMessage('è¯·æ±‚å‡ºé”™ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°','error');
    }
  }
  document.getElementById('addExperimentForm').addEventListener('submit', saveExperiment);

  async function loadExperimentList() {
    const username = sessionStorage.getItem('username') || localStorage.getItem('username');
    if (!username) return;
    try {
      const res = await fetch(`${BASE_URL}/getExperiments?username=` + encodeURIComponent(username));
      const data = await res.json();
      if (!data || !data.success) {
        console.warn('æ‹‰å–å®éªŒè®°å½•å¤±è´¥', data);
        return;
      }
      const container = document.getElementById('experiment-list');
      container.innerHTML = '';
      (data.data || []).forEach(item => {
        prependRecordToUI('experiment', {
          id: item.id,
          expName: item.expName,
          expDate: item.expDate || item.created_at,
          expData: item.expData,
          expNote: item.expNote,
          created_at: item.created_at
        }, { temp: false });
      });
    } catch (err) {
      console.error('åŠ è½½å®éªŒè®°å½•å‡ºé”™ï¼š', err);
    }
  }

  // -------------------- è®ºæ–‡è¿›åº¦ï¼šä¿å­˜ & æ‹‰å– --------------------
  async function submitThesisProgress(evt) {
    if (evt && evt.preventDefault) evt.preventDefault();
    const username = sessionStorage.getItem('username') || localStorage.getItem('username');
    if (!username) { showMessage('æœªæ£€æµ‹åˆ°ç™»å½•ç”¨æˆ·ï¼Œè¯·å…ˆç™»å½•','error'); return; }

    const progressSummary = document.getElementById('progressSummary').value.trim();
    const completedItems = document.getElementById('completedTasks').value.trim();
    const resultOutput = document.getElementById('output').value.trim();
    const problemsEncountered = document.getElementById('issues').value.trim();
    const nextPlan = document.getElementById('nextPlan').value.trim();
    if (!progressSummary) { showMessage('è¯·å¡«å†™è¿›åº¦æ¦‚è¿°','error'); return; }

    try {
      const payload = { username, progressSummary, completedItems, resultOutput, problemsEncountered, nextPlan };
      const res = await fetch(`${BASE_URL}/saveProgress`, {
        method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data && data.success) {
        showMessage('è®ºæ–‡è¿›åº¦ä¿å­˜æˆåŠŸ','success');

        // ä¸´æ—¶æ¸²æŸ“
        const tempRec = { id: 'temp-progress-' + Date.now(), progress_summary: progressSummary, completed_items: completedItems, result_output: resultOutput, problems_encountered: problemsEncountered, next_plan: nextPlan, created_at: new Date().toISOString() };
        prependRecordToUI('paper', tempRec, { temp: true });

        document.getElementById('progressForm').reset();
        await loadProgressList();
      } else {
        showMessage('ä¿å­˜å¤±è´¥ï¼š' + (data && (data.error || data.reason) ? (data.error || data.reason) : 'æœªçŸ¥é”™è¯¯'),'error');
        console.error('saveProgress response', data);
      }
    } catch (err) {
      console.error(err);
      showMessage('è¯·æ±‚å‡ºé”™ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°','error');
    }
  }
  document.getElementById('progressForm').addEventListener('submit', submitThesisProgress);

  async function loadProgressList() {
    const username = sessionStorage.getItem('username') || localStorage.getItem('username');
    if (!username) return;
    try {
      const res = await fetch(`${BASE_URL}/getProgress?username=` + encodeURIComponent(username));
      const data = await res.json();
      if (!data || !data.success) { console.warn('æ‹‰å–è¿›åº¦å¤±è´¥', data); return; }
      const container = document.getElementById('progress-list');
      container.innerHTML = '';
      (data.data || []).forEach(item => {
        prependRecordToUI('paper', {
          id: item.id,
          progress_summary: item.progress_summary,
          completed_items: item.completed_items,
          result_output: item.result_output,
          problems_encountered: item.problems_encountered,
          next_plan: item.next_plan,
          created_at: item.created_at
        }, { temp: false });
      });
    } catch (err) {
      console.error('åŠ è½½è¿›åº¦å‡ºé”™ï¼š', err);
    }
  }

  // -------------------- æ–‡çŒ®ï¼šä¿å­˜ & æ‹‰å– --------------------
  async function saveLiterature(evt) {
    if (evt && evt.preventDefault) evt.preventDefault();
    const username = sessionStorage.getItem('username') || localStorage.getItem('username');
    if (!username) { showMessage('æœªæ£€æµ‹åˆ°ç™»å½•ç”¨æˆ·ï¼Œè¯·å…ˆç™»å½•','error'); return; }

    const title = document.getElementById('title').value.trim();
    const authors = document.getElementById('authors').value.trim();
    const journal = document.getElementById('journal').value.trim();
    const yearVal = document.getElementById('year').value;
    const keywords = document.getElementById('keywords').value.trim();
    const abstractTxt = document.getElementById('abstract').value.trim();
    const link = document.getElementById('link').value.trim();
    const notes = document.getElementById('notes').value.trim();

    if (!title || !authors) { showMessage('è¯·å¡«å†™æ–‡çŒ®æ ‡é¢˜å’Œä½œè€…','error'); return; }

    try {
      showMessage('æ­£åœ¨ä¿å­˜æ–‡çŒ®...', 'info');
      const payload = { username, title, authors, journal, year: yearVal ? parseInt(yearVal,10) : null, keywords, abstract: abstractTxt, link, notes };
      const res = await fetch(`${BASE_URL}/addLiterature`, {
        method:'POST', headers:{ 'Content-Type':'application/json;charset=utf-8' }, body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data && data.success) {
        showMessage('æ–‡çŒ®ä¿å­˜æˆåŠŸï¼', 'success');
        document.getElementById('literatureForm').reset();
        // ä¸´æ—¶æ¸²æŸ“
        prependRecordToUI('literature', { id: 'temp-lit-' + Date.now(), title, authors, journal, created_at: new Date().toISOString() }, { temp: true });
        await loadLiteratureList();
      } else {
        showMessage('ä¿å­˜å¤±è´¥ï¼š' + (data && (data.error || data.reason) ? (data.error || data.reason) : 'æœªçŸ¥é”™è¯¯'), 'error');
        console.error('addLiterature response', data);
      }
    } catch (err) {
      console.error(err);
      showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥', 'error');
    }
  }
  document.getElementById('literatureForm').addEventListener('submit', saveLiterature);

  async function loadLiteratureList() {
    const username = sessionStorage.getItem('username') || localStorage.getItem('username');
    if (!username) return;
    try {
      const res = await fetch(`${BASE_URL}/getLiterature?username=` + encodeURIComponent(username));
      const data = await res.json();
      if (!data || !data.success) { console.warn('æ‹‰å–æ–‡çŒ®å¤±è´¥', data); return; }
      const container = document.getElementById('literature-list');
      container.innerHTML = '';
      (data.data || []).forEach(item => {
        prependRecordToUI('literature', { id: item.id, title: item.title, authors: item.authors, journal: item.journal, created_at: item.created_at }, { temp: false });
      });
    } catch (err) {
      console.error('åŠ è½½æ–‡çŒ®å¤±è´¥ï¼š', err);
    }
  }

  // -------------------- æ—¥å¿—ï¼šä¿å­˜ & æ‹‰å– --------------------
  async function saveLogToServer(content, title=null) {
    const username = sessionStorage.getItem('username') || localStorage.getItem('username');
    if (!username) { showMessage('æœªæ£€æµ‹åˆ°ç™»å½•ç”¨æˆ·ï¼Œè¯·å…ˆç™»å½•','error'); return { success:false, error:'æœªç™»å½•' }; }
    try {
      const res = await fetch(`${BASE_URL}/addLog`, {
        method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ username, title, content })
      });
      const data = await res.json();
      return data;
    } catch (err) {
      console.error('ä¿å­˜æ—¥å¿—å‡ºé”™:', err);
      return { success:false, error: err.message || 'ç½‘ç»œé”™è¯¯' };
    }
  }

  document.getElementById('save-log').addEventListener('click', async function(){
    const contentEl = document.getElementById('log-input');
    const content = contentEl.value.trim();
    if (!content) { showMessage('æ—¥å¿—å†…å®¹ä¸èƒ½ä¸ºç©º','error'); return; }
    showMessage('æ­£åœ¨ä¿å­˜æ—¥å¿—...','info');
    const result = await saveLogToServer(content, null);
    if (result && result.success) {
      showMessage('æ—¥å¿—ä¿å­˜æˆåŠŸ','success');
      contentEl.value = '';
      if (result.log) prependRecordToUI('log', result.log);
      // reload logs to ensure consistency
      await loadUserLogs();
    } else {
      showMessage('ä¿å­˜å¤±è´¥ï¼š' + (result && result.error ? result.error : 'æœªçŸ¥é”™è¯¯'),'error');
    }
  });

  async function loadUserLogs() {
    const username = sessionStorage.getItem('username') || localStorage.getItem('username');
    if (!username) return;
    try {
      const res = await fetch(`${BASE_URL}/getLogs?username=` + encodeURIComponent(username));
      const data = await res.json();
      if (!data || !data.success) { console.warn('æ‹‰å–æ—¥å¿—å¤±è´¥', data); return; }
      const container = document.getElementById('logsList');
      container.innerHTML = '';
      (data.data || []).forEach(item => {
        prependRecordToUI('log', { id: item.id, title: item.title, content: item.content, created_at: item.created_at }, { temp: false });
      });
    } catch (err) {
      console.error('åŠ è½½æ—¥å¿—å¤±è´¥ï¼š', err);
    }
  }

  // -------------------- æ—¥å†æ¸²æŸ“ --------------------
  const monthYear = document.getElementById("month-year");
  const calendarBody = document.getElementById("calendar-body");
  let today = new Date();
  let currentMonth = today.getMonth();
  let currentYear = today.getFullYear();

  function renderCalendar(month, year) {
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    monthYear.textContent = `${year}å¹´ ${month + 1}æœˆ`;

    calendarBody.innerHTML = "";
    let date = 1;
    for (let i = 0; i < 6; i++) {
      const row = document.createElement("tr");
      for (let j = 0; j < 7; j++) {
        const cell = document.createElement("td");
        if (i === 0 && j < firstDay) {
          cell.textContent = "";
        } else if (date > daysInMonth) {
          cell.textContent = "";
        } else {
          cell.textContent = date;
          if (date === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
            cell.style.background = '#0348b0';
            cell.style.color = '#fff';
            cell.style.borderRadius = '50%';
          }
          date++;
        }
        row.appendChild(cell);
      }
      calendarBody.appendChild(row);
    }
  }
  document.getElementById("prev-month").addEventListener("click", () => { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } renderCalendar(currentMonth, currentYear); });
  document.getElementById("next-month").addEventListener("click", () => { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } renderCalendar(currentMonth, currentYear); });
  renderCalendar(currentMonth, currentYear);

  // -------------------- é¡µé¢åŠ è½½æ—¶æ‹‰å–æ•°æ® --------------------
  window.addEventListener('load', async () => {
    await loadUserLogs();
    await loadExperimentList();
    await loadProgressList();
    await loadLiteratureList();
  });
</script>
</body>
</html>
